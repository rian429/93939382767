local UIS = game:GetService("UserInputService")
local VIM = game:GetService("VirtualInputManager")
local LP = game.Players.LocalPlayer
local PlayerGui = LP:WaitForChild("PlayerGui")

-- Remove old UI
if PlayerGui:FindFirstChild("PandaPanda_LegacyReturn") then
    PlayerGui.PandaPanda_LegacyReturn:Destroy()
end

local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "PandaPanda_LegacyReturn"
sg.ResetOnSpawn = false

local isLocked = false
local points = {}

-- Get target button under a point
local function getTarget(frame)
    local x, y = frame.AbsolutePosition.X + 25, frame.AbsolutePosition.Y + 25
    local objs = PlayerGui:GetGuiObjectsAtPosition(x, y)
    for _, obj in pairs(objs) do
        if (obj:IsA("GuiButton") or obj:IsA("ImageButton")) and not obj:FindFirstAncestor("PandaPanda_LegacyReturn") then
            return obj
        end
    end
    return nil
end

-- Make frame draggable (topmost-only)
local function makeDraggable(frame)
    local dragging, dragStart, startPos

    frame.InputBegan:Connect(function(input)
        if isLocked then return end
        if input.UserInputType ~= Enum.UserInputType.MouseButton1 and input.UserInputType ~= Enum.UserInputType.Touch then return end

        -- Check topmost point under cursor
        local x, y = input.Position.X, input.Position.Y
        local top = nil
        for _, p in ipairs(points) do
            local absPos, size = p.AbsolutePosition, p.AbsoluteSize
            if x >= absPos.X and x <= absPos.X + size.X and y >= absPos.Y and y <= absPos.Y + size.Y then
                top = p -- last in loop = topmost
            end
        end

        if top ~= frame then return end

        dragging = true
        dragStart = input.Position
        startPos = frame.Position
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and not isLocked and (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement) then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end)

    UIS.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
end

-- Create a draggable point
local function createPoint(id, color, pos)
    local f = Instance.new("Frame", sg)
    f.Name = "Point"..id
    f.Size = UDim2.new(0, 50, 0, 50)
    f.Position = pos
    f.BackgroundColor3 = color
    f.BackgroundTransparency = 0.4
    Instance.new("UICorner", f).CornerRadius = UDim.new(1, 0)

    local l = Instance.new("TextLabel", f)
    l.Size = UDim2.new(1,0,1,0)
    l.Text = tostring(id)
    l.TextColor3 = Color3.new(1,1,1)
    l.BackgroundTransparency = 1
    l.Font = Enum.Font.SourceSansBold
    l.TextSize = 25

    makeDraggable(f)
    table.insert(points, f)
    return f
end

-- Initial 3 points
local p1 = createPoint(1, Color3.fromRGB(0, 160, 255), UDim2.new(0.5, -25, 0.7, 0))
local p2 = createPoint(2, Color3.fromRGB(255, 20, 147), UDim2.new(0.5, -25, 0.8, 0))
local p3 = createPoint(3, Color3.fromRGB(0, 255, 150), UDim2.new(0.5, -25, 0.9, 0))

-- Play Macro Button
local play = Instance.new("TextButton", sg)
play.Name = "MainBtn"
play.Size = UDim2.new(0, 80, 0, 80)
play.Position = UDim2.new(0.1, 0, 0.5, -40)
play.BackgroundColor3 = Color3.fromRGB(0, 255, 120)
play.Text = "Macro"
play.TextColor3 = Color3.new(1,1,1)
play.Font = Enum.Font.SourceSansBold
Instance.new("UICorner", play).CornerRadius = UDim.new(1, 0)
makeDraggable(play)

-- Lock UI Button
local lockBtn = Instance.new("TextButton", sg)
lockBtn.Size = UDim2.new(0, 90, 0, 30)
lockBtn.Position = UDim2.new(0, 10, 0, 10)
lockBtn.Text = "ðŸ”“ UNLOCK"
lockBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
lockBtn.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", lockBtn)

lockBtn.MouseButton1Click:Connect(function()
    isLocked = not isLocked
    lockBtn.Text = isLocked and "ðŸ”’ LOCKED" or "ðŸ”“ UNLOCK"
    lockBtn.BackgroundColor3 = isLocked and Color3.fromRGB(200, 50, 50)
